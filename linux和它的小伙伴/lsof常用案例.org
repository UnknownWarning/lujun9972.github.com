#+TITLE: lsof常用案例
#+AUTHOR: lujun9972
#+TAGS: linux和它的小伙伴
#+DATE: [2019-02-27 三 11:58]
#+LANGUAGE:  zh-CN
#+OPTIONS:  H:6 num:nil toc:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:nil

https://linuxhandbook.com/lsof-command

* lsof输出格式说明
#+BEGIN_SRC shell :results org
  lsof |head
#+END_SRC

#+BEGIN_SRC org
COMMAND     PID   TID TASKCMD        USER   FD      TYPE             DEVICE  SIZE/OFF       NODE NAME
systemd    1260                 lujun9972  cwd       DIR                8,2      4096          2 /
systemd    1260                 lujun9972  rtd       DIR                8,2      4096          2 /
systemd    1260                 lujun9972  txt       REG                8,2   1468520     407557 /usr/lib/systemd/systemd
systemd    1260                 lujun9972  mem       REG                8,2   1587104     396269 /usr/lib/libm-2.28.so
systemd    1260                 lujun9972  mem       REG                8,2    149496     449887 /usr/lib/libudev.so.1.6.13
systemd    1260                 lujun9972  mem       REG                8,2   1570608     465164 /usr/lib/libunistring.so.2.1.0
systemd    1260                 lujun9972  mem       REG                8,2    137216     405459 /usr/lib/libgpg-error.so.0.26.1
systemd    1260                 lujun9972  mem       REG                8,2     67504     464769 /usr/lib/libjson-c.so.4.0.0
systemd    1260                 lujun9972  mem       REG                8,2     34432     395345 /usr/lib/libargon2.so.1
#+END_SRC

其中 =FD= 列表示文件描述符(file descriptor),它的常用值包括:

+ cwd :: 当前工作目录
+ txt :: 文本文件
+ mem :: 内存映射文件
+ mmap :: 内存映射设备
+ 数字 :: 实际的文件描述符号

        
=TYPE= 列表示文件类型，常用值包括:

+ REG :: 普通文件
+ DIR :: 目录
+ CHR :: 字符设备文件
+ FIFO :: 管道文件

* lsof常见案例

** 列出打开某个文件的所有进程
#+BEGIN_SRC shell
  lsof $path_to_file
#+END_SRC

** 列出某个文件打开的所有文件
#+BEGIN_SRC shell
  lsof -u $user
#+END_SRC

允许指定多个用户
#+BEGIN_SRC shell
  lsof -u $user1,$user2
#+END_SRC

** 列出某个目录内所有打开的文件
#+BEGIN_SRC shell
  lsof +D $directory
#+END_SRC

** 列出被某个进程打开的所有文件
#+BEGIN_SRC shell
  lsof -p $pid
#+END_SRC
也支持多个进程
#+BEGIN_SRC shell
  lsof -p $pid1,$pid2
#+END_SRC

** 列出被某个命令打开的所有文件
#+BEGIN_SRC shell
  lsof -c $command
#+END_SRC


** 列出打开网络连接的命令

列出所有打开网络连接的命令:
#+BEGIN_SRC shell
  lsof -i
#+END_SRC

指定协议:
#+BEGIN_SRC shell
  lsof -i tcp
#+END_SRC

指定端口:
#+BEGIN_SRC shell
  lsof -i :$port
#+END_SRC


** 补集
在关键字前加上 =^= 表示对关键字取补集,例如
#+BEGIN_SRC shell
  lsof -u ^root
#+END_SRC

** 同时满足多个条件
使用 =-a= 选项表示 =AND= 操作:
#+BEGIN_SRC shell
  lsof -a -u $user -c $command
#+END_SRC
